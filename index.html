<script>
  const redirectUrl = "https://thebetpoint.app/dl/063968";

  // Wait for WTN and OneSignal to initialize
  function waitForOneSignal(callback) {
    if (window.WTN?.OneSignal) {
      callback(window.WTN.OneSignal);
    } else {
      console.log("⏳ Waiting for WTN.OneSignal...");
      setTimeout(() => waitForOneSignal(callback), 300);
    }
  }

  // ✅ Define custom function to set external user ID (without overwriting)
  function setExternalUserId(id) {
    try {
      // Android bridge
      if (window.Android?.setExternalUserId) {
        window.Android.setExternalUserId(id);
        console.log("✅ Android externalUserId set:", id);
      }
      // iOS bridge
      else if (window.webkit?.messageHandlers?.setExternalUserId) {
        window.webkit.messageHandlers.setExternalUserId.postMessage(id);
        console.log("✅ iOS externalUserId set:", id);
      }
      else {
        console.warn("❌ Bridge not ready, retrying...");
        setTimeout(() => setExternalUserId(id), 300);
      }
    } catch (err) {
      console.error("Error setting external user ID:", err);
    }
  }

  // ✅ Link device function
  function linkDevice() {
    const userId = document.getElementById("userIdInput").value.trim();
    if (!userId) {
      alert("Please enter your User ID.");
      return;
    }

    // Wait for the bridge, then do both actions
    waitForOneSignal((OneSignalBridge) => {
      // 1️⃣ Link the device
      setExternalUserId(userId);

      // 2️⃣ Set tag to track premium or link status
      if (OneSignalBridge.setTags) {
        OneSignalBridge.setTags({ linked: "true", user_id: userId });
        console.log("✅ Tags set for user:", userId);
      } else {
        console.warn("⚠️ setTags not available yet");
      }

      alert("Device linked and tags set successfully!");
      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 1000);
    });
  }
</script>
